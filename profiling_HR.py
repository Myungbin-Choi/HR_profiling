# -*- coding: utf-8 -*-
"""Kaggle_HR.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1OgNwgv0GcNpFf-CzYNQz1-omvtDQMvXQ

# 0. í™˜ê²½ì„¤ì • ë° ì›Œí¬ë²¤ì¹˜ ì„¸íŒ…

## ì›Œí¬ë²¤ì¹˜ ì„¸íŒ…
"""

! pip install pandas sqlalchemy pymysql -q

user = 'root'
password = 'password'
host = 'localhost'
port = 3306
database = 'Kaggle_HR'

from sqlalchemy import create_engine

# 1) ì»¤ë„¥ì…˜ URL ìƒì„±
url = f"mysql+pymysql://{user}:{password}@{host}:{port}/{database}?charset=utf8mb4"
engine = create_engine(url)

data_path = 'wfs_behaviors_and_records_508p-546d-98r_20220722173739.csv'
hr_df = pd.read_csv(data_path, encoding='cp1252')

hr_df.to_sql('hr_table', engine, if_exists='append', index=False)

"""## VSCODE ì„¸íŒ…"""

! pip install koreanize_matplotlib

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import koreanize_matplotlib

data_path = 'wfs_behaviors_and_records_508p-546d-98r_20220722173739.csv'
hr_df = pd.read_csv(data_path, encoding='cp1252')

"""## êµ¬ê¸€ ì„¸íŒ…"""

from google.colab import drive
drive.mount('/content/drive')

! pip install koreanize_matplotlib

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt
import seaborn as sns
import koreanize_matplotlib

data_path = '/content/drive/MyDrive/á„ƒá…¦á„‹á…µá„á…¥á„‡á…®á†«á„‰á…¥á†¨_á„€á…¢á„‹á…µá†«/wfs_behaviors_and_records_508p-546d-98r_20220722173739.csv'
hr_df = pd.read_csv(data_path, encoding='cp1252')

"""# 1. ìš°ë¦¬ íšŒì‚¬ ì§ì› í˜„í™©

## íšŒì‚¬ í˜„í™© í™•ì¸
"""

hr_df.head(2)

# ì§ì› ê¸°ì´ˆ í˜„í™©
unique_df = hr_df.drop_duplicates(subset='sub_ID')

total_count = unique_df['sub_ID'].nunique()
avg_age = unique_df['sub_age'].mean()
total_female = (unique_df['sub_sex'] == 'F').sum()  # () ì¡°ê±´ì´ ì°¸ì¸ ê²½ìš° 1
total_male = (unique_df['sub_sex'] == 'M').sum()

print(f'ì „ì²´ ì¸ì›: {total_count}ëª…')
print(f'ë‚˜ì´ í‰ê· : {avg_age:.1f}')
print(f'ì—¬ì„± ì§ì› ìˆ˜: {total_female}ëª…')
print(f'ë‚¨ì„± ì§ì› ìˆ˜: {total_male}ëª…')

# ì§ì› ì—­ëŸ‰ í‰ê·  í™•ì¸
avg_health = unique_df['sub_health_h'].mean()
avg_commitment = unique_df['sub_commitment_h'].mean()
avg_perceptiveness = unique_df['sub_perceptiveness_h'].mean()
avg_dexterity = unique_df['sub_dexterity_h'].mean()
avg_sociality = unique_df['sub_sociality_h'].mean()
avg_goodness = unique_df['sub_goodness_h'].mean()
avg_strength = unique_df['sub_strength_h'].mean()
avg_openmindness = unique_df['sub_openmindedness_h'].mean()

print('ìš°ë¦¬ íšŒì‚¬ì˜ ì§ì› ì—­ëŸ‰ í‰ê· ')
print(f'ê±´ê°•: {avg_health:.3f}')
print(f'í—Œì‹ ë„: {avg_commitment:.3f}')
print(f'ì¸ì§€ë ¥: {avg_perceptiveness:.3f}')
print(f'ì†ì¬ì£¼: {avg_dexterity:.3f}')
print(f'ì‚¬íšŒì„±: {avg_sociality:.3f}')
print(f'ì„ ëŸ‰í•¨: {avg_goodness:.3f}')
print(f'í˜: {avg_strength:.3f}')
print(f'ìˆ˜ìš©ì„±: {avg_openmindness:.3f}')

# shift, team ë³„ í˜„í™©
shift_info = unique_df.groupby(['sub_shift', 'sub_team']).agg({
	'sub_ID': 'nunique',
	'sub_age' : 'mean',
  	'sub_sex': [
    	('ì—¬ì„±', lambda x: (x=='F').sum()),
   		('ë‚¨ì„±', lambda x: (x=='M').sum())
  ]
})

shift_info.reset_index(inplace=True)
shift_info.columns = ['shift', 'team', 'ì¸ì›ìˆ˜', 'í‰ê·  ë‚˜ì´', 'ì—¬ì„±', 'ë‚¨ì„±']
print(shift_info)

# shift, team ë³„ ì—­ëŸ‰ í‰ê· 
shift_info = unique_df.groupby(['sub_shift', 'sub_team']).agg({
  'sub_health_h':'mean',
  'sub_commitment_h' :'mean',
  'sub_perceptiveness_h':'mean',
  'sub_dexterity_h':'mean',
  'sub_sociality_h':'mean',
  'sub_goodness_h':'mean',
  'sub_strength_h':'mean',
  'sub_openmindedness_h':'mean'
})

shift_info.reset_index(inplace=True)
shift_info.columns = ['shift', 'team', 'ê±´ê°•', 'í—Œì‹ ë„', 'ì¸ì§€ë ¥', 'ì†ì¬ì£¼', 'ì‚¬íšŒì„±', 'ì„ ëŸ‰í•¨', 'í˜', 'ìˆ˜ìš©ì„±']
print(shift_info)

"""## ìƒì‚°ì„± ë³€í™”"""

recent_df = recent_df[recent_df['event_date'].dt.year == 2022]

recent_df['event_month'] = recent_df['event_date'].dt.to_period('M').dt.to_timestamp()

group_efficacy = recent_df.groupby(['event_month', 'performance_group'])['actual_efficacy_h'].mean().reset_index()
group_efficacy

plt.figure(figsize=(12, 6))
line_plot = sns.lineplot(data=group_efficacy, x='event_month', y='actual_efficacy_h', hue='performance_group', marker='o')

for line in group_efficacy['performance_group'].unique():
    group_data = group_efficacy[group_efficacy['performance_group'] == line]
    for x, y in zip(group_data['event_month'], group_data['actual_efficacy_h']):
        plt.text(x, y + 0.05, f'{y:.2f}', ha='center', fontsize=9)

plt.grid(True, which='major', axis='both', linestyle='--', alpha=0.5)
plt.title('Efficacy change')
plt.xlabel('month')
plt.ylabel('efficacy')
plt.legend(title='performance group')
plt.tight_layout()
plt.show()

plt.figure(figsize=(12, 6))
sns.lineplot(data=recent_df, x='event_month', y='actual_efficacy_h', marker='o')
plt.grid(True, which='major', axis='both', linestyle='--', alpha=0.5)
plt.title('Efficacy change')
plt.xlabel('month')
plt.ylabel('efficacy')
plt.tight_layout()
plt.show()

recent_df.groupby(by='performance_group')['actual_efficacy_h'].mean()

"""# 2. ê³ ì„±ê³¼ì í™•ì¸
- ê³ ì„±ê³¼ì ê¸°ì¤€ : event_date ê¸°ì¤€ ìµœê·¼ 6ê°œì›” ì´ë‚´, efficacy í‰ê· , ìƒìœ„ 20%

## performance group ë¶„ë¥˜
"""

hr_df.head(2)

hr_df['behav_comptype_h'].value_counts()

hr_df['event_date'] = pd.to_datetime(hr_df['event_date'])

from dateutil.relativedelta import relativedelta

latest_date = hr_df['event_date'].max()
six_month_ago = latest_date - relativedelta(months=6)
recent_df = hr_df[hr_df['event_date'] >= six_month_ago]

recent_df.shape

hr_df.shape

recent_df.head(2)

recent_df['behav_comptype_h'].value_counts()

# sub_IDë³„ actual_efficacy_h í‰ê· ì„ ê¸°ì¤€ìœ¼ë¡œ ì„±ê³¼ê·¸ë£¹ ë¶„ë¥˜ í•„ìš”

# ì¼ë‹¨ sub_IDë³„ ìƒì‚°ì„± í‰ê· ì„ êµ¬í•˜ê¸°
avg_efficacy = recent_df.groupby('sub_ID').agg({'actual_efficacy_h':'mean'})

# ìƒì‚°ì„± í‰ê· ì„ ê¸°ì¤€ìœ¼ë¡œ performance_group ë§Œë“¤ê¸°
avg_efficacy['performance_group'] = pd.qcut(
    avg_efficacy['actual_efficacy_h'],
    q=5,
    labels=[5,4,3,2,1]
)

avg_efficacy.reset_index(inplace=True)

# recent_dfì— ë³‘í•©
recent_df = recent_df.merge(avg_efficacy[['sub_ID', 'performance_group']], on='sub_ID', how='left')

"""## ê·¸ë£¹ë³„ ì—­ëŸ‰ ì°¨ì´ í™•ì¸"""

perf_group_competency = recent_df.groupby(['performance_group']).agg({
  'sub_age':'mean',
  'sub_health_h':'mean',
  'sub_commitment_h' :'mean',
  'sub_perceptiveness_h':'mean',
  'sub_dexterity_h':'mean',
  'sub_sociality_h':'mean',
  'sub_goodness_h':'mean',
  'sub_strength_h':'mean',
  'sub_openmindedness_h':'mean',
  'actual_efficacy_h': 'mean'
})

perf_group_competency

from scipy.stats import f_oneway

# ì—­ëŸ‰ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
competency_cols = [
    'sub_age', 'sub_health_h', 'sub_commitment_h', 'sub_perceptiveness_h',
    'sub_dexterity_h', 'sub_sociality_h', 'sub_goodness_h',
    'sub_strength_h', 'sub_openmindedness_h'
]

# ê° ì»¬ëŸ¼ì— ëŒ€í•´ ANOVA ìˆ˜í–‰
anova_results = {}
for col in competency_cols:
    groups = [group[col].dropna().values for name, group in recent_df.groupby('performance_group')]
    f_stat, p_val = f_oneway(*groups)
    anova_results[col] = {'F-statistic': f_stat, 'p-value': p_val}

# ê²°ê³¼ í™•ì¸
import pandas as pd
anova_df = pd.DataFrame(anova_results).T
anova_df.sort_values('p-value')

"""<mark> openmindednessëŠ” ê·¸ë£¹ë³„ë¡œ ìœ ì˜ë¯¸í•œ ì°¨ì´ê°€ ìˆë‹¤."""

# Tukey HSD ì‚¬í›„ê²€ì • : ì„±ê³¼ ê·¸ë£¹ ê°„ ê°œë°©ì„± ì§€í‘œ í‰ê·  ì°¨ì´ê°€ ìœ ì˜ë¯¸í•œì§€ ë¹„êµ
from statsmodels.stats.multicomp import pairwise_tukeyhsd

tukey = pairwise_tukeyhsd(endog=recent_df['sub_openmindedness_h'],
                          groups=recent_df['performance_group'],
                          alpha=0.05)
print(tukey.summary())

"""| ì»¬ëŸ¼                 | ì˜ë¯¸                             |
| ------------------ | ------------------------------ |
| `group1`, `group2` | ë¹„êµí•œ ì„±ê³¼ ê·¸ë£¹                      |
| `meandiff`         | ê·¸ë£¹ ê°„ í‰ê·  ì°¨ì´ (`group2 - group1`) |
| `p-adj`            | ì¡°ì •ëœ p-value (ë‹¤ì¤‘ë¹„êµ ë³´ì •ëœ ê°’)       |
| `lower`, `upper`   | í‰ê·  ì°¨ì´ì˜ ì‹ ë¢°êµ¬ê°„ (95%)              |
| `reject`           | `True`ë©´ ìœ ì˜ë¯¸í•œ ì°¨ì´ ìˆìŒ (ê·€ë¬´ê°€ì„¤ ê¸°ê°)   |

```python
- ê³ ì„±ê³¼ì ê·¸ë£¹ì¼ìˆ˜ë¡ sub_openmindedness_hê°€ ë‚®ì€ ê²½í–¥ì¼ ìˆ˜ ìˆìŒ
- íŠ¹íˆ 2ë²ˆ ê·¸ë£¹ì´ ê°œë°©ì„±ì´ ê°€ì¥ ë†’ê³ , 3ë²ˆì´ ë‚®ìŒ
- ëª¨ë“  ê·¸ë£¹ ê°„ ì°¨ì´ê°€ ìœ ì˜ë¯¸í•˜ê¸° ë•Œë¬¸ì—, ì„ í˜•ì ì´ì§„ ì•Šì•„ë„ ê³„ì¸µì  êµ¬ë¶„ì´ ëšœë ·í•˜ë‹¤ê³  í•´ì„ ê°€ëŠ¥
```
"""

import seaborn as sns
import matplotlib.pyplot as plt

sns.boxplot(x='performance_group', y='sub_openmindedness_h', data=recent_df, order=[1,2,3,4,5])
plt.title('ê°œë°©ì„± ì ìˆ˜ ë¶„í¬ (ì„±ê³¼ê·¸ë£¹ë³„)')
plt.xlabel('Performance Group (1=Best)')
plt.ylabel('Openmindedness')
plt.show()

"""## ê·¸ë£¹ë³„ ìŠˆí¼ë°”ì´ì € ì°¨ì´ í™•ì¸"""

recent_df['performance_group'] = recent_df['performance_group'].astype(int)

recent_df.columns

perf_group_sup = recent_df.groupby(['performance_group']).agg({
  'sup_age':'mean',
  'sup_sub_age_diff':'mean',
  'sup_commitment_h':'mean',
  'sup_perceptiveness_h':'mean',
  'sup_goodness_h':'mean'
})


perf_group_sup

# ì—­ëŸ‰ ì»¬ëŸ¼ ë¦¬ìŠ¤íŠ¸
sup_cols = ['sup_age', 'sup_sub_age_diff', 'sup_commitment_h','sup_perceptiveness_h', 'sup_goodness_h']

# ê° ì»¬ëŸ¼ì— ëŒ€í•´ ANOVA ìˆ˜í–‰
anova_results = {}
for col in sup_cols:
    groups = [group[col].dropna().values for name, group in recent_df.groupby('performance_group')]
    f_stat, p_val = f_oneway(*groups)
    anova_results[col] = {'F-statistic': f_stat, 'p-value': p_val}

# ê²°ê³¼ í™•ì¸
import pandas as pd
anova_df = pd.DataFrame(anova_results).T
anova_df.sort_values('p-value')

tukey = pairwise_tukeyhsd(endog=recent_df['sup_goodness_h'],
                          groups=recent_df['performance_group'],
                          alpha=0.05)
print(tukey.summary())

recent_df.isnull().sum()

# nan ê°’ ì œì™¸í•˜ê³  ë¶„ì„
df_tukey = recent_df[['sup_goodness_h', 'performance_group']].dropna()
tukey = pairwise_tukeyhsd(endog=df_tukey['sup_goodness_h'],
                          groups=df_tukey['performance_group'],
                          alpha=0.05)
print(tukey.summary())

sns.boxplot(x='performance_group', y='sup_goodness_h', data=recent_df)
plt.title('sup_goodness_h by Performance Group')
plt.show()

"""# 3. ìƒì‚°ì„±ê³¼ ê´€ë ¨ ìˆëŠ” ì§€í‘œ í™•ì¸

## ì „ì²˜ë¦¬
"""

recent_df.columns

efficacy_df = recent_df[(recent_df['behav_comptype_h'] == 'Efficacy')]

efficacy_df.shape

efficacy_df.drop(columns=['sub_fname', 'sub_lname', 'sub_shift', 'sub_team', 'sub_role', 'sub_coll_IDs', 'sub_workstyle_h', 'sup_ID', 'sup_fname', 'sup_lname', 'sup_sex','sup_role', 'event_week_in_series','event_day_in_series',  'behav_comptype_h', 'behav_cause_h',  'record_comptype', 'record_cause', 'recorded_efficacy', 'recorded_note_from_sup', 'record_conf_matrix_h'], inplace=True)

efficacy_df.head(2)

# ë‚¨ì 0, ì—¬ì 1
efficacy_df['sub_sex'] = (efficacy_df['sub_sex'] == 'F').astype(int)

# ìš”ì¼ ìˆ«ìë¡œ ë³€í™˜
weekday_mapping = {
    'Monday': 1,
    'Tuesday': 2,
    'Wednesday': 3,
    'Thursday': 4,
    'Friday': 5,
    'Saturday': 6
}

efficacy_df['event_weekday_name'] = efficacy_df['event_weekday_name'].map(weekday_mapping)

efficacy_df.dtypes

"""## ìƒê´€ê´€ê³„ í™•ì¸"""

plt.figure(figsize=(15, 15))
sns.heatmap(efficacy_df.corr(), annot=True, fmt='.2f', cmap='coolwarm')
plt.show()

plt.figure(figsize=(5, 5))
sns.scatterplot(data=efficacy_df, x='sub_health_h', y='actual_efficacy_h')
plt.show()

"""### ê°œì¸ì˜ ì—­ëŸ‰ê³¼ ìƒì‚°ì„± í‰ê·  ìƒê´€ê´€ê³„"""

# sub_idë³„ë¡œ ì—­ëŸ‰, efficacy í‰ê· ì„ ë‚¸ ë‹¤ìŒ í•´ë‹¹ ë°ì´í„°ë¡œ ìƒê´€ê´€ê³„ ë¶„ì„
sub_com_eff_avg = recent_df.groupby(by='sub_ID')[['sub_health_h', 'sub_commitment_h', 'sub_perceptiveness_h', 'sub_dexterity_h', 'sub_sociality_h', 'sub_goodness_h', 'sub_strength_h', 'sub_openmindedness_h', 'actual_efficacy_h']].mean().reset_index()
sub_com_eff_avg.head(2)

plt.figure(figsize=(7, 7))
sns.heatmap(sub_com_eff_avg.corr(), annot=True, fmt='.2f', cmap='coolwarm')
plt.show()

plt.figure(figsize=(5, 5))
sns.scatterplot(data=sub_com_eff_avg, x='sub_health_h', y='actual_efficacy_h', color='blue')
sns.regplot(data=sub_com_eff_avg, x='sub_health_h', y='actual_efficacy_h',
            scatter=False, line_kws={'color': 'red'})
plt.show()

x_vars = [
    'sub_health_h', 'sub_commitment_h', 'sub_perceptiveness_h',
    'sub_dexterity_h', 'sub_sociality_h', 'sub_goodness_h',
    'sub_strength_h', 'sub_openmindedness_h'
]

# ê·¸ë˜í”„ ì‚¬ì´ì¦ˆ ì„¤ì •
plt.figure(figsize=(15, 15))

# ê° ë³€ìˆ˜ì— ëŒ€í•´ subplotìœ¼ë¡œ ê·¸ë¦¼
for i, x in enumerate(x_vars):
    plt.subplot(3, 3, i + 1)  # 3í–‰ 3ì—´ ë°°ì—´, ì¸ë±ìŠ¤ëŠ” 1ë¶€í„° ì‹œì‘
    sns.scatterplot(data=sub_com_eff_avg, x=x, y='actual_efficacy_h', color='blue')
    sns.regplot(data=sub_com_eff_avg, x=x, y='actual_efficacy_h',
                scatter=False, line_kws={'color': 'red'})
    plt.title(f'{x} vs actual_efficacy_h')

plt.tight_layout()
plt.show()

"""### ì°¨ì› ì¶•ì†Œ í›„ ì‹œê°í™”"""

from sklearn.decomposition import PCA

pca = PCA(n_components=1)
sub_com_eff_avg['pca_comp'] = pca.fit_transform(sub_com_eff_avg[x_vars])
sns.regplot(data=sub_com_eff_avg, x='pca_comp', y='actual_efficacy_h')

"""### ì˜ˆì¸¡ëª¨ë¸ ê¸°ë°˜ í”¼ì²˜ ì¤‘ìš”ë„ ë¶„ì„"""

from sklearn.ensemble import RandomForestRegressor
from sklearn.model_selection import train_test_split

X = sub_com_eff_avg[x_vars]
y = sub_com_eff_avg['actual_efficacy_h']

model = RandomForestRegressor()
model.fit(X, y)

# ì¤‘ìš”ë„ ì‹œê°í™”
importances = pd.Series(model.feature_importances_, index=x_vars)
importances.sort_values().plot(kind='barh')

"""### í´ëŸ¬ìŠ¤í„°ë§ ê¸°ë°˜"""

from sklearn.cluster import KMeans

kmeans = KMeans(n_clusters=3)
sub_com_eff_avg['cluster'] = kmeans.fit_predict(sub_com_eff_avg[x_vars])
sns.boxplot(data=sub_com_eff_avg, x='cluster', y='actual_efficacy_h')

"""# 4. ì‹œê°„ì— ë”°ë¥¸ ì„±ê³¼ ë³€í™” ë¶„ì„

- ì–´ë–¤ ìˆœì„œë¡œ í•´ì•¼í•˜ì§€?
    - 1) recent_df['performance_group'] = 1ì¸ ë°ì´í„° ì¶”ì¶œ
    - 2) 1)ì˜ ì„±ê³¼ê°€ ê°€ì¥ ì¢‹ì€ sub_IDì˜ event_date, event_week, event_weekday_name, behav_comptype_h, actual_efficacy_h ì—¬ì • í™•ì¸ & ì‹œê°í™”
    - 3) 2)ì—ì„œ ì„±ê³¼ê°€ ê°€ì¥ ì¢‹ì€ ìˆœê°„ ì•ë’¤ì˜ ì´ë²¤íŠ¸ í™•ì¸
    - 4) 2)ì—ì„œ ì„±ê³¼ê°€ ë–¨ì–´ì§€ëŠ” ìˆœê°„ ì•ë’¤ì˜ ì´ë²¤íŠ¸ í™•ì¸
    - 5) ìœ„ì˜ ìˆœì„œë¥¼ ì—¬ëŸ¬ ëª…ì˜ sub_IDì˜ ì—¬ì •ì„ ë°˜ë³µ ì¶”ì¶œí•˜ë©´ì„œ ì¼ë°˜í™”í•  ìˆ˜ ìˆëŠ” ê²°ë¡  ì¶”ì¶œ

## ìƒì‚°ì„± 1ìœ„
"""

# 1) recent_df['performance_group'] = 1ì¸ ë°ì´í„° ì¶”ì¶œ
high_performers_df = recent_df[(recent_df['performance_group'] == 1)]
high_performers_df.shape

# 2) ì„±ê³¼ê°€ ê°€ì¥ ë†’ì€ id í™•ì¸
top_performer = high_performers_df.loc[high_performers_df['actual_efficacy_h'].idxmax()]
top_performer_id = top_performer['sub_ID']
print(top_performer_id)

# 3) top_performer sub_IDì˜ event_date, event_week, event_weekday_name, behav_comptype_h, actual_efficacy_h ì—¬ì • í™•ì¸ & ì‹œê°í™”
top_performer_df = high_performers_df[(high_performers_df['sub_ID'] == top_performer_id)]
top_performer_df = top_performer_df[['sub_ID', 'sub_coll_IDs', 'sub_colls_same_sex_prtn', 'event_date', 'event_weekday_num', 'event_weekday_name', 'behav_comptype_h', 'behav_cause_h', 'actual_efficacy_h']]

top_performer_df.shape

top_performer_df.head(20)

# behave_comptype_h ê°€ Presenceì¸ í•­ëª© ì‚­ì œ
top_performer_df = top_performer_df[(top_performer_df['behav_comptype_h'] != 'Presence')]
top_performer_df.reset_index(inplace=True)
top_performer_df.shape

top_performer_df.head(50)

top_performer_df['behav_comptype_h'].value_counts()

avg_efficacy = top_performer_df['actual_efficacy_h'].mean()
avg_efficacy

# actual_efficacy_h ì‹œê°í™”

plt.figure(figsize=(18, 5))
sns.lineplot(data=top_performer_df, x='event_date', y='actual_efficacy_h')

# í‰ê· ì„  ì¶”ê°€
avg_efficacy = top_performer_df['actual_efficacy_h'].mean()
plt.axhline(avg_efficacy, color='green', linestyle='--', label=f'Mean ({avg_efficacy:.2f})')

plt.title('Actual Efficacy Over Time for Top Performer')
plt.xlabel('Event Date', fontsize=14)
plt.ylabel('Actual Efficacy (h)', fontsize=14)
plt.grid(True, linestyle='--', alpha=0.5)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

# Teamwork ì•ë’¤ë¡œ efficacy í™•ì¸
teamwork_idxs = top_performer_df[top_performer_df['behav_comptype_h'] == 'Feat'].index

# 5ì¼ ì „í›„ ìƒì‚°ì„± ì¶”ì¶œ
results = []

for idx in teamwork_idxs:
    # ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
    if idx >= 5 and idx <= len(top_performer_df) - 6:
        pre_efficacy = top_performer_df.loc[idx-5:idx-1, 'actual_efficacy_h'].dropna()
        post_efficacy = top_performer_df.loc[idx+1:idx+5, 'actual_efficacy_h'].dropna()

        if len(pre_efficacy) > 0 and len(post_efficacy) > 0:
            results.append({
                'event_date': top_performer_df.loc[idx, 'event_date'],
                'pre_mean': pre_efficacy.mean(),
                'post_mean': post_efficacy.mean(),
                'change': post_efficacy.mean() - pre_efficacy.mean()
            })

change_df = pd.DataFrame(results)

print("í‰ê·  ë³€í™”ëŸ‰ (5ì¼ í›„ - 5ì¼ ì „):", change_df['change'].mean())

"""<mark> teamwork í›„ ìƒì‚°ì„±ì´ ë–¨ì–´ì§€ëŠ” ê²½í–¥ì´ ìˆìœ¼ë‚˜ í¬ì§€ ì•ŠìŒ"""

plt.figure(figsize=(10, 6))
sns.histplot(change_df['change'], kde=True)
plt.axvline(change_df['change'].mean(), color='red', linestyle='--', label='í‰ê·  ë³€í™”ëŸ‰')
plt.title("Teamwork ì´ë²¤íŠ¸ ì „í›„ (5ì¼ ê°„) actual_efficacy ë³€í™”ëŸ‰ ë¶„í¬")
plt.xlabel("ë³€í™”ëŸ‰ (Post - Pre)")
plt.legend()
plt.show()

# ì´ë²¤íŠ¸ë³„ ìƒì‚°ì„± ë³€í™”ëŸ‰ ë¹„êµ
event_types = top_performer_df['behav_comptype_h'].dropna().unique()
all_results = []

for event in event_types:
    idxs = top_performer_df[top_performer_df['behav_comptype_h'] == event].index
    for idx in idxs:
        if idx >= 5 and idx <= len(top_performer_df) - 6:
            pre = top_performer_df.loc[idx-5:idx-1, 'actual_efficacy_h'].dropna()
            post = top_performer_df.loc[idx+1:idx+5, 'actual_efficacy_h'].dropna()
            if len(pre) > 0 and len(post) > 0:
                all_results.append({
                    'event': event,
                    'pre_mean': pre.mean(),
                    'post_mean': post.mean(),
                    'change': post.mean() - pre.mean()
                })

event_change_df = pd.DataFrame(all_results)

event_change_df

# ì´ë²¤íŠ¸ë³„ ìƒì‚°ì„± ë³€í™”ëŸ‰ ì‹œê°í™”
plt.figure(figsize=(12, 6))
sns.boxplot(data=event_change_df, x='event', y='change', palette='Set2')
plt.axhline(0, color='gray', linestyle='--')
plt.title('Change in Productivity (Efficacy) by Event Type', fontsize=14)
plt.ylabel('Post - Pre Efficacy Change')
plt.xlabel('Event Type')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

"""- 0ë³´ë‹¤ ìœ„ â†’ ì´ë²¤íŠ¸ í›„ ìƒì‚°ì„± ìƒìŠ¹
- 0ë³´ë‹¤ ì•„ë˜ â†’ ì´ë²¤íŠ¸ í›„ ìƒì‚°ì„± í•˜ë½
- ë°•ìŠ¤ ê¸¸ì´ â†’ ì¼ê´€ì„±(ë³€ë™ì„±)
"""

# ì´ë²¤íŠ¸ë³„ ì‚¬ì „-ì‚¬í›„ ë¶„í¬
feat_df = event_change_df[event_change_df['event'] == 'Sacrifice']

sns.kdeplot(feat_df['pre_mean'], label='Before', fill=True)
sns.kdeplot(feat_df['post_mean'], label='After', fill=True)
plt.title('Distribution of Efficacy Before and After "Sacrifice" Event')
plt.xlabel('Efficacy')
plt.legend()
plt.tight_layout()
plt.show()

"""## ìƒì‚°ì„± 2ìœ„"""

df = high_performers_df.groupby(by='sub_ID')['actual_efficacy_h'].mean().sort_values(ascending=False).reset_index()
df.head(15)

# 3) top_performer sub_IDì˜ event_date, event_week, event_weekday_name, behav_comptype_h, actual_efficacy_h ì—¬ì • í™•ì¸ & ì‹œê°í™”
second_performer_df = high_performers_df[(high_performers_df['sub_ID'] == 98000294)]
second_performer_df = second_performer_df[['sub_ID', 'event_date', 'event_weekday_num', 'event_weekday_name', 'behav_comptype_h', 'behav_cause_h', 'actual_efficacy_h']]

second_performer_df.shape

# behave_comptype_h ê°€ Presenceì¸ í•­ëª© ì‚­ì œ
second_performer_df = second_performer_df[(second_performer_df['behav_comptype_h'] != 'Presence')]
second_performer_df.reset_index(inplace=True)
second_performer_df.shape

# actual_efficacy_h ì‹œê°í™”

avg_efficacy = second_performer_df['actual_efficacy_h'].mean()
avg_efficacy

plt.figure(figsize=(18, 5))
sns.lineplot(data=second_performer_df, x='event_date', y='actual_efficacy_h')

# í‰ê· ì„  ì¶”ê°€
avg_efficacy = second_performer_df['actual_efficacy_h'].mean()
plt.axhline(avg_efficacy, color='green', linestyle='--', label=f'Mean ({avg_efficacy:.2f})')

plt.title('Actual Efficacy Over Time for Second Performer')
plt.xlabel('Event Date', fontsize=14)
plt.ylabel('Actual Efficacy (h)', fontsize=14)
plt.grid(True, linestyle='--', alpha=0.5)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

second_performer_df['behav_comptype_h'].value_counts()

# Teamwork ì•ë’¤ë¡œ efficacy í™•ì¸
teamwork_idxs = second_performer_df[second_performer_df['behav_comptype_h'] == 'Absence'].index

# 5ì¼ ì „í›„ ìƒì‚°ì„± ì¶”ì¶œ
results = []

for idx in teamwork_idxs:
    # ë²”ìœ„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
    if idx >= 5 and idx <= len(second_performer_df) - 6:
        pre_efficacy = second_performer_df.loc[idx-5:idx-1, 'actual_efficacy_h'].dropna()
        post_efficacy = second_performer_df.loc[idx+1:idx+5, 'actual_efficacy_h'].dropna()

        if len(pre_efficacy) > 0 and len(post_efficacy) > 0:
            results.append({
                'event_date': second_performer_df.loc[idx, 'event_date'],
                'pre_mean': pre_efficacy.mean(),
                'post_mean': post_efficacy.mean(),
                'change': post_efficacy.mean() - pre_efficacy.mean()
            })

change_df = pd.DataFrame(results)

print("í‰ê·  ë³€í™”ëŸ‰ (5ì¼ í›„ - 5ì¼ ì „):", change_df['change'].mean())

plt.figure(figsize=(10, 6))
sns.histplot(change_df['change'], kde=True)
plt.axvline(change_df['change'].mean(), color='red', linestyle='--', label='í‰ê·  ë³€í™”ëŸ‰')
plt.title("ê²°ê·¼ ì „í›„ (5ì¼ ê°„) actual_efficacy ë³€í™”ëŸ‰ ë¶„í¬")
plt.xlabel("ë³€í™”ëŸ‰ (Post - Pre)")
plt.legend()
plt.show()

"""# 6. íŠ¹ì • ì´ë²¤íŠ¸ ë¹ˆë„ ê¸°ì¤€ ìƒì‚°ì„± ì¶”ì´"""

# ê³ ì„±ê³¼ê·¸ë£¹ì˜ ì§ì›ë³„ Teamwork/Sacrifice ì´ë²¤íŠ¸ ìˆ˜ ì„¸ê¸°
event_counts = high_performers_df[high_performers_df['behav_comptype_h'].isin(['Teamwork', 'Sacrifice'])] \
    .groupby(['sub_ID', 'behav_comptype_h']) \
    .size().unstack(fill_value=0).reset_index()

event_counts

# ìƒìœ„ ê·¸ë£¹ ê¸°ì¤€ ì •ì˜
sacrifice_threshold = event_counts['Sacrifice'].quantile(0.75)
teamwork_threshold = event_counts['Teamwork'].quantile(0.75)

# ê·¸ë£¹ ë¼ë²¨ë§
event_counts['high_sacrifice'] = event_counts['Sacrifice'] >= sacrifice_threshold
event_counts['high_teamwork'] = event_counts['Teamwork'] >= teamwork_threshold

merged = high_performers_df.merge(event_counts[['sub_ID', 'high_sacrifice', 'high_teamwork']], on='sub_ID', how='left')

# ë‚ ì§œ ê¸°ì¤€ ìƒì‚°ì„± í‰ê·  (ì˜ˆ: ì£¼ ë‹¨ìœ„)
merged['event_week'] = pd.to_datetime(merged['event_date']).dt.to_period('W').dt.to_timestamp()

# Sacrifice ê¸°ì¤€ ë¹„êµ
sac_curve = merged.groupby(['event_week', 'high_teamwork'])['actual_efficacy_h'].mean().reset_index()

plt.figure(figsize=(14, 6))
sns.lineplot(data=sac_curve, x='event_week', y='actual_efficacy_h', hue='high_teamwork', palette='Set2')
plt.title('Long-term Productivity Comparison: High vs Low teamwork')
plt.ylabel('Avg Actual Efficacy (h)')
plt.xlabel('Week')
plt.legend(title='High teamwork')
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

"""## ìƒìœ„ 25%, í•˜ìœ„ 25% ë¹„êµ

### íŒ€ì›Œí¬
"""

# ìƒí•˜ìœ„ 25% ì„ê³„ê°’ ê³„ì‚°
teamwork_q75 = event_counts['Teamwork'].quantile(0.75)
teamwork_q25 = event_counts['Teamwork'].quantile(0.25)

sacrifice_q75 = event_counts['Sacrifice'].quantile(0.75)
sacrifice_q25 = event_counts['Sacrifice'].quantile(0.25)

# teamwork ìƒí•˜ìœ„ ê·¸ë£¹
def teamwork_group(val):
    if val >= teamwork_q75:
        return 'high'
    elif val <= teamwork_q25:
        return 'low'
    else:
        return 'middle'

event_counts['teamwork_group'] = event_counts['Teamwork'].apply(teamwork_group)

# ë³‘í•©
merged = high_performers_df.merge(event_counts[['sub_ID', 'teamwork_group']], on='sub_ID', how='left')

# ì£¼ ë‹¨ìœ„ ì£¼ì°¨
merged['event_week'] = pd.to_datetime(merged['event_date']).dt.to_period('W').dt.to_timestamp()

# ìƒí•˜ìœ„ ê·¸ë£¹ë§Œ í•„í„°ë§
filtered = merged[merged['teamwork_group'].isin(['high', 'low'])]

# ê·¸ë£¹ë³„ ì£¼ì°¨ë³„ ìƒì‚°ì„± í‰ê· 
curve = filtered.groupby(['event_week', 'teamwork_group'])['actual_efficacy_h'].mean().reset_index()

plt.figure(figsize=(14, 6))
sns.lineplot(data=curve, x='event_week', y='actual_efficacy_h', hue='teamwork_group', palette='Set1')
plt.title('Productivity Over Time: High vs Low Teamwork Group')
plt.ylabel('Avg Actual Efficacy (h)')
plt.xlabel('Week')
plt.legend(title='Teamwork Group')
plt.xticks(rotation=45)
plt.grid(True, linestyle='--', alpha=0.4)
plt.tight_layout()
plt.show()

"""### í¬ìƒ"""

# Sacrifice ìƒí•˜ìœ„ 25% ê¸°ì¤€ ê³„ì‚°
sacrifice_q75 = event_counts['Sacrifice'].quantile(0.75)
sacrifice_q25 = event_counts['Sacrifice'].quantile(0.25)

# ê·¸ë£¹ êµ¬ë¶„ í•¨ìˆ˜ ì •ì˜
def sacrifice_group(val):
    if val >= sacrifice_q75:
        return 'high'
    elif val <= sacrifice_q25:
        return 'low'
    else:
        return 'middle'

# ì ìš©
event_counts['sacrifice_group'] = event_counts['Sacrifice'].apply(sacrifice_group)

# ë³‘í•©
merged_sac = high_performers_df.merge(event_counts[['sub_ID', 'sacrifice_group']], on='sub_ID', how='left')

# ì£¼ì°¨ ìƒì„±
merged_sac['event_week'] = pd.to_datetime(merged_sac['event_date']).dt.to_period('W').dt.to_timestamp()

# ìƒí•˜ìœ„ ê·¸ë£¹ë§Œ í•„í„°ë§
filtered_sac = merged_sac[merged_sac['sacrifice_group'].isin(['high', 'low'])]

# ì£¼ì°¨ë³„ í‰ê·  efficacy ê³„ì‚°
sac_curve = filtered_sac.groupby(['event_week', 'sacrifice_group'])['actual_efficacy_h'].mean().reset_index()

plt.figure(figsize=(14, 6))
sns.lineplot(data=sac_curve, x='event_week', y='actual_efficacy_h', hue='sacrifice_group', palette='Dark2')
plt.title('Productivity Over Time: High vs Low Sacrifice Group')
plt.ylabel('Avg Actual Efficacy (h)')
plt.xlabel('Week')
plt.legend(title='Sacrifice Group')
plt.grid(True, linestyle='--', alpha=0.5)
plt.xticks(rotation=45)
plt.tight_layout()
plt.show()

"""# 7. ìƒì‚°ì„± ê¸°ì¤€ ê´€ë¦¬ í•„ìš” ê³ ì„±ê³¼ì ë¶„ë¥˜"""

high_performers_df.head(2)

high_performers_df.columns

high_performers_df.gropuby('sub_ID').agg

high_performer_avg_efficacy = high_performers_df.groupby('sub_ID').agg({'actual_efficacy_h': 'mean'}).reset_index()

high_performer_avg_efficacy['actual_efficacy_h'].sort_values(ascending=False)

efficacy_top_performers = high_performers_df[high_performers_df['actual_efficacy_h'] >= 2]

efficacy_top_performers.shape

top_df = efficacy_top_performers.groupby(by = 'sub_ID').agg({'actual_efficacy_h':'mean'}).reset_index()

top_df.head(2)

top_df.mean()

merge_top_df = pd.merge(top_df, high_performers_df, on='sub_ID', how='inner')

merge_top_df['sub_'].mean()

merge_top_df.columns

"""# 8. ì„±ê³¼ ê¸‰ë“±/ê¸‰ë½ ì¤‘ì¸ ì§ì›

- ìµœê·¼ 1ê°œì›” efficacy í‰ê·  êµ¬í•˜ê¸°
- ìµœê·¼ 1ê°œì›” ì œì™¸ efficacy í‰ê·  êµ¬í•˜ê¸°
- efficacy í‰ê· ì´ ì§€ë‚œ í‰ê·  ëŒ€ë¹„ ë§ì´ ì˜¬ë¼ê°„ 5ì¸
- efficacy í‰ê· ì´ ì§€ë‚œ í‰ê·  ëŒ€ë¹„ ë§ì´ ë–¨ì–´ì§„ 5ì¸
"""

recent_df.head(2)

# ì›” ì •ë³´ ì»¬ëŸ¼ ì¶”ê°€
recent_df['month'] = recent_df['event_date'].dt.month

# 1~5ì›” í‰ê·  efficacy
jan_to_may = recent_df[recent_df['month'].between(1, 5)]
jan_may_avg = jan_to_may.groupby('sub_ID')['actual_efficacy_h'].mean().rename('avg_1_5')

# 6ì›” í‰ê·  efficacy
june = recent_df[recent_df['month'] == 6]
june_avg = june.groupby('sub_ID')['actual_efficacy_h'].mean().rename('avg_6')

# ë‘ ê²°ê³¼ ë³‘í•©
efficacy_change = pd.concat([jan_may_avg, june_avg], axis=1).dropna()

# ë³€í™”ëŸ‰ ê³„ì‚°
efficacy_change['diff'] = efficacy_change['avg_6'] - efficacy_change['avg_1_5']

# ë§ì´ ì˜¤ë¥¸ 5ëª…
top_5_risers = efficacy_change.sort_values(by='diff', ascending=False).head(5)

# ë§ì´ ë–¨ì–´ì§„ 5ëª…
top_5_fallers = efficacy_change.sort_values(by='diff', ascending=True).head(5)

# ê²°ê³¼ í™•ì¸
print("ğŸ”º ë§ì´ ì˜¤ë¥¸ 5ëª…:")
print(top_5_risers)

print("\nğŸ”» ë§ì´ ë–¨ì–´ì§„ 5ëª…:")
print(top_5_fallers)

# top 10ëª… sub_id ì¶”ì¶œ
top_10_ids = pd.concat([top_5_risers, top_5_fallers]).index.tolist()

# ì›ë³¸ì—ì„œ ì´ sub_idì— í•´ë‹¹í•˜ëŠ” ì‚¬ëŒ ì •ë³´ ì¶”ì¶œ (6ì›” ê¸°ì¤€ ê°€ì¥ ìµœì‹  ë°ì´í„° í•œ ì¤„ë§Œ)
latest_info = (
    recent_df[recent_df['sub_ID'].isin(top_10_ids)]
    .sort_values(by='event_date', ascending=False)
    .drop_duplicates(subset='sub_ID')[['sub_ID', 'sub_fname', 'sub_lname', 'sub_shift', 'sub_team']]
    .set_index('sub_ID')
)

# ìµœì¢… ë³‘í•©
final_result = pd.concat([efficacy_change.loc[top_10_ids], latest_info], axis=1)

# ì •ë ¬ (diff ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ â†’ í•˜ë½ì´ ì•„ë˜ë¡œ)
final_result = final_result.sort_values(by='diff', ascending=False)

# ê²°ê³¼ ì¶œë ¥
print(final_result)

